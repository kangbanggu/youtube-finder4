<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartTube Finder â€” ë²¤ì¹˜ë§ˆí‚¹</title>
<style>
  :root{--accent:#e60023;--muted:#6b7280}
  body{font-family:Noto Sans KR, Arial, sans-serif;background:#f7fafc;margin:0;padding:18px;color:#111}
  .wrap{max-width:980px;margin:0 auto}
  h1{color:var(--accent);text-align:center;margin:6px 0 18px}
  .box{background:#fff;padding:12px;border-radius:12px;box-shadow:0 4px 18px rgba(10,10,10,0.06);margin-bottom:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button{padding:8px 10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;width:100%;box-sizing:border-box}
  button{background:var(--accent);color:#fff;border:none;cursor:pointer;width:auto}
  .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  #results{display:grid;gap:12px;margin-top:12px}
  .card{background:#fff;border-radius:10px;padding:10px;display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:start;box-shadow:0 2px 8px rgba(0,0,0,0.04);transition:all 0.2s}
  .card:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,0.08)}
  .thumb{width:100%;height:92px;object-fit:cover;border-radius:8px}
  .title{font-weight:700;margin:0 0 6px}
  .meta{font-size:13px;color:#374151}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;background:#f3f4f6;margin-right:6px}
  .ratio-good{color:#16a34a;font-weight:700}
  .ratio-bad{color:#dc2626;font-weight:700}
  .small{font-size:12px;color:#6b7280}
  .note{font-size:13px;color:#6b7280;margin-top:6px}
  @media(max-width:640px){.card{grid-template-columns:120px 1fr}.thumb{height:80px}}
  .section-title{margin:12px 0 6px;font-weight:700}
  #usageCounter { text-align:right; font-size:13px; color:#555; margin-bottom:8px; }
  .pagination { text-align:center; margin-top:20px; }
  .pagination button { margin:0 4px; padding:6px 10px; border-radius:6px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“ˆ SmartTube Finder â€” ë²¤ì¹˜ë§ˆí‚¹</h1>

  <div id="usageCounter">ì¿¼í„° ì”ì—¬: 10000 / 10000</div>

  <div class="box">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input id="q" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ë³µì§€ ì‚¬ì—°, ê±´ê°•, ë‹¤ì´ì–´íŠ¸)" style="flex:1" />
      <button id="searchBtn">ê²€ìƒ‰</button>
    </div>

    <div style="margin-top:10px" class="filters">
      <div><label>êµ¬ë¶„ (íƒ€ì…)</label>
        <select id="typeFilter"><option value="any">ì „ì²´</option><option value="video">ì¼ë°˜ì˜ìƒ</option><option value="shorts">ì‡¼ì¸ </option><option value="live">ë¼ì´ë¸Œ</option><option value="channel">ì±„ë„</option></select>
      </div>

      <div><label>ì—…ë¡œë“œ ê¸°ê°„</label>
        <select id="timeFilter"><option value="any">ì „ì²´</option><option value="today">ì˜¤ëŠ˜</option><option value="week">ìµœê·¼ 1ì£¼</option><option value="month">ì´ë²ˆ ë‹¬</option><option value="3months">3ê°œì›”</option><option value="6months">6ê°œì›”</option><option value="year">ì˜¬í•´</option></select>
      </div>

      <div><label>ì¡°íšŒìˆ˜ (ìµœì†Œ ~ ìµœëŒ€)</label>
        <div style="display:flex;gap:6px">
          <input id="minViews" type="number" placeholder="ìµœì†Œ"/>
          <input id="maxViews" type="number" placeholder="ìµœëŒ€"/>
        </div>
      </div>

      <div><label>êµ¬ë…ì (ìµœì†Œ ~ ìµœëŒ€)</label>
        <div style="display:flex;gap:6px">
          <input id="minSubs" type="number" placeholder="ìµœì†Œ"/>
          <input id="maxSubs" type="number" placeholder="ìµœëŒ€"/>
        </div>
      </div>

      <div><label>ì •ë ¬</label>
        <select id="sortBy"><option value="ratio">íš¨ìœ¨ìˆœ</option><option value="views">ì¡°íšŒìˆ˜ ìˆœ</option><option value="subs">êµ¬ë…ì ìˆœ</option></select>
      </div>

      <div><label>ê²°ê³¼ ê°¯ìˆ˜</label>
        <select id="maxResults"><option value="10">10</option><option value="20" selected>20</option><option value="30">30</option></select>
      </div>
    </div>

    <div class="note">ì„¤ëª…: ì‡¼ì¸  = &lt; 4ë¶„, ë¯¸ë“œí¼ = 4ë¶„~10ë¶„, ë¡±í¼ = â‰¥ 10ë¶„.</div>
  </div>

  <div id="results">
    <div class="box"><div class="section-title">ğŸ¬ ì‡¼ì¸  (4ë¶„ ë¯¸ë§Œ)</div><div id="shorts"></div></div>
    <div class="box"><div class="section-title">â± ë¯¸ë“œí¼ (4 - 10ë¶„)</div><div id="mid"></div></div>
    <div class="box"><div class="section-title">ğŸ“º ë¡±í¼ (10ë¶„ ì´ìƒ)</div><div id="longs"></div></div>
    <div class="box"><div class="section-title">ğŸ“ ì±„ë„ ê²°ê³¼</div><div id="channels"></div></div>
  </div>

  <div class="pagination" id="pagination"></div>
  <div id="status" class="small" style="margin-top:10px"></div>
</div>

<script>
/* ---------- ì„¤ì • ---------- */
const API_KEY = "AIzaSyBMA6UbKczjPJkqExjd4_evvq3nUz-Agi8"; // ì´ë¯¸ ë„£ì–´ë‘ì‹  í‚¤
const TOTAL_QUOTA = 10000; // ì „ì²´ ì¿¼í„°
let usedQuota = 0;         // ì‚¬ìš©í•œ ì¿¼í„°
let currentPage = 1;
const itemsPerPage = 10;
let allRows = [];

/* ---------- ìœ í‹¸ ---------- */
function updateUsageDisplay(){
  const remain = Math.max(TOTAL_QUOTA - usedQuota, 0);
  document.getElementById('usageCounter').textContent = `ì¿¼í„° ì”ì—¬: ${remain} / ${TOTAL_QUOTA}`;
}

function isoToSeconds(iso){
  if(!iso) return 0;
  const h = Number((iso.match(/(\d+)H/) || [0,0])[1]||0);
  const m = Number((iso.match(/(\d+)M/) || [0,0])[1]||0);
  const s = Number((iso.match(/(\d+)S/) || [0,0])[1]||0);
  return h*3600 + m*60 + s;
}

/* ---------- ë Œë”ë§ ---------- */
function renderCard(r){
  const videoUrl = r.kind === 'channel' ? `https://www.youtube.com/channel/${r.id}` : `https://www.youtube.com/watch?v=${r.id}`;
  const badge = r.kind==='channel' ? 'ì±„ë„' : (r.isShort ? 'ì‡¼ì¸ ' : r.isMid ? 'ë¯¸ë“œí¼' : 'ë¡±í¼');
  const subsText = r.subs !== undefined ? r.subs.toLocaleString() : '-';
  const viewsText = r.views !== undefined ? r.views.toLocaleString() : '-';
  const effText = r.efficiency === null ? 'N/A' : Number(r.efficiency).toFixed(2) + 'x';
  const published = r.publishedAt ? new Date(r.publishedAt).toLocaleDateString() : '-';
  const thumb = r.thumbnail || '';

  return `
  <a href="${videoUrl}" target="_blank" style="text-decoration:none;color:inherit;">
    <div class="card">
      <div><img class="thumb" src="${thumb}" alt="thumb"></div>
      <div>
        <div class="small"><span class="badge">${badge}</span></div>
        <div class="title">${r.title}</div>
        <div class="meta small">${r.kind==='video' ? `ì±„ë„: ${r.channelTitle || ''}` : ''}</div>
        <div class="meta">ì¡°íšŒìˆ˜: <strong>${viewsText}</strong> Â· êµ¬ë…ì: <strong>${subsText}</strong></div>
        <div class="meta">íš¨ìœ¨: <strong class="${r.efficiency && r.efficiency>=5 ? 'ratio-good' : r.efficiency && r.efficiency<1 ? 'ratio-bad' : ''}">${effText}</strong></div>
        <div class="meta">ì—…ë¡œë“œ: ${published}</div>
      </div>
    </div>
  </a>`;
}

function renderPage(page){
  const shortsEl = document.getElementById('shorts');
  const midEl = document.getElementById('mid');
  const longsEl = document.getElementById('longs');
  const channelsEl = document.getElementById('channels');
  shortsEl.innerHTML = midEl.innerHTML = longsEl.innerHTML = channelsEl.innerHTML = "";

  const start = (page - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const pageItems = allRows.slice(start, end);

  for(const r of pageItems){
    const html = renderCard(r);
    if(r.kind==='channel') channelsEl.insertAdjacentHTML('beforeend', html);
    else if(r.isShort) shortsEl.insertAdjacentHTML('beforeend', html);
    else if(r.isMid) midEl.insertAdjacentHTML('beforeend', html);
    else longsEl.insertAdjacentHTML('beforeend', html);
  }

  renderPagination();
}

function renderPagination(){
  const totalPages = Math.ceil(allRows.length / itemsPerPage);
  const container = document.getElementById('pagination');
  container.innerHTML = "";
  if(totalPages <= 1) return;
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement('button');
    btn.textContent = i;
    if(i === currentPage) btn.style.background = "#e60023";
    btn.onclick = ()=>{ currentPage=i; renderPage(currentPage); };
    container.appendChild(btn);
  }
}

/* ---------- ê²€ìƒ‰ ë¡œì§ (ì¿¼í„° ê³„ì‚° í¬í•¨) ---------- */
document.getElementById('searchBtn').addEventListener('click', onSearch);

async function onSearch(){
  document.getElementById('status').textContent = "ê²€ìƒ‰ ì¤‘...";
  const q = document.getElementById('q').value.trim();
  if(!q){ alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  // 1) search.list í˜¸ì¶œ (ì¿¼í„°: 100)
  usedQuota += 100;
  updateUsageDisplay();

  const maxResults = Number(document.getElementById('maxResults').value) || 20;
  const sUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(q)}&maxResults=${maxResults}&key=${API_KEY}`;
  const sRes = await fetch(sUrl);
  const sData = await sRes.json();
  if(sData.error){ document.getElementById('status').textContent = `ì˜¤ë¥˜: ${sData.error.message}`; return; }

  // collect video IDs and channel IDs
  const videoIds = [];
  const channelIds = new Set();
  for(const it of sData.items || []){
    if(it.id.kind === 'youtube#video'){
      videoIds.push(it.id.videoId);
      if(it.snippet && it.snippet.channelId) channelIds.add(it.snippet.channelId);
    } else if(it.id.kind === 'youtube#channel'){
      channelIds.add(it.id.channelId);
    }
  }

  // 2) videos.list í˜¸ì¶œ (ì¿¼í„°: 1 per video)
  if(videoIds.length === 0){
    allRows = [];
    currentPage = 1;
    renderPage(currentPage);
    document.getElementById('status').textContent = 'ê²°ê³¼ ì—†ìŒ';
    return;
  }

  usedQuota += videoIds.length * 1;
  updateUsageDisplay();

  const vUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,statistics&id=${videoIds.join(',')}&key=${API_KEY}`;
  const vRes = await fetch(vUrl);
  const vData = await vRes.json();
  if(vData.error){ document.getElementById('status').textContent = `ì˜¤ë¥˜: ${vData.error.message}`; return; }

  // 3) channels.list í˜¸ì¶œ for subscriber counts (optional, quota 1 per channel)
  const chList = Array.from(channelIds);
  let channelsMap = {};
  if(chList.length){
    // charge channel quota only if needed
    usedQuota += chList.length * 1;
    updateUsageDisplay();
    const cUrl = `https://www.googleapis.com/youtube/v3/channels?part=statistics,snippet&id=${chList.join(',')}&key=${API_KEY}`;
    const cRes = await fetch(cUrl);
    const cData = await cRes.json();
    if(!cData.error){
      for(const c of cData.items || []) channelsMap[c.id] = c;
    }
  }

  // 4) ê°€ê³µ: duration ê¸°ë°˜ ë¶„ë¥˜ ë° rows ìƒì„±
  const rows = [];
  for(const v of vData.items || []){
    const durationSec = isoToSeconds(v.contentDetails?.duration);
    const isShort = durationSec > 0 && durationSec < 4*60;       // < 4ë¶„
    const isMid = durationSec >= 4*60 && durationSec < 10*60;     // 4~10ë¶„
    const isLong = durationSec >= 10*60;                         // >=10ë¶„
    const channelId = v.snippet?.channelId;
    const ch = channelsMap[channelId] || null;
    const subs = ch ? Number(ch.statistics.subscriberCount || 0) : undefined;
    const views = Number(v.statistics?.viewCount || 0);
    const eff = subs ? (views / subs) : null;

    rows.push({
      kind: 'video',
      id: v.id,
      title: v.snippet.title,
      thumbnail: v.snippet.thumbnails?.medium?.url || '',
      channelId,
      channelTitle: v.snippet.channelTitle,
      subs,
      views,
      efficiency: eff,
      durationSec,
      isShort, isMid, isLong,
      publishedAt: v.snippet.publishedAt
    });
  }

  // ì±„ë„ íƒ€ì…(ê²€ìƒ‰ì—ì„œ ì±„ë„ì´ í¬í•¨ëœ ê²½ìš°) ì²˜ë¦¬: (í•„ìš”í•˜ë©´ ë³„ë„ ì¶”ê°€)
  // í˜„ì¬ focusëŠ” ë¹„ë””ì˜¤ ìœ„ì£¼ì´ë¯€ë¡œ ì±„ë„ ê²°ê³¼ëŠ” ë¹„ë””ì˜¤ ëª©ë¡ê³¼ ë³„ê°œë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ.

  // ì €ì¥ ë° ë Œë”
  allRows = rows;
  currentPage = 1;
  renderPage(currentPage);
  updateUsageDisplay();
  document.getElementById('status').textContent = `${allRows.length}ê°œì˜ ê²°ê³¼`;
}

/* ì´ˆê¸° í‘œì‹œ */
updateUsageDisplay();
</script>
</body>
</html>
