<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartTube Finder â€” ë²¤ì¹˜ë§ˆí‚¹</title>

<style>
  :root { --accent:#e60023; --muted:#6b7280; }

  body {
    font-family:Noto Sans KR, Arial, sans-serif;
    background:#f7fafc; margin:0; padding:18px; color:#111;
  }
  .wrap { max-width:980px; margin:0 auto; }

  h1 { color:var(--accent); text-align:center; margin:6px 0 18px; }

  .box{
    background:#fff; padding:12px; border-radius:12px;
    box-shadow:0 4px 18px rgba(10,10,10,0.06); margin-bottom:14px;
  }

  input,select,button{
    padding:8px 10px; border-radius:8px;
    border:1px solid #d1d5db; font-size:14px;
  }

  button{
    background:var(--accent); color:#fff;
    border:none; cursor:pointer; width:auto;
  }

  label{ color:var(--muted); font-size:13px; margin-bottom:4px; display:block;}

  #results { display:grid; gap:12px; margin-top:12px; }

  /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .card{
    background:#fff; border-radius:10px; padding:10px;
    display:grid; grid-template-columns:140px 1fr; gap:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.04);
    transition:0.2s;
  }
  .card:hover{ transform:scale(1.02); }

  .thumb { width:100%; height:92px; object-fit:cover; border-radius:8px; }

  .title { font-weight:700; margin:4px 0; }

  .badge{
    display:inline-block; background:#f3f4f6; padding:4px 8px;
    border-radius:999px; font-size:12px; margin-right:6px;
  }

  /* íš¨ìœ¨ ë§‰ëŒ€ê·¸ë˜í”„ */
  .bar-wrap{
    width:100%; height:8px; background:#e5e7eb;
    border-radius:6px; margin-top:4px; overflow:hidden;
  }
  .bar{
    height:100%; width:0%; background:#16a34a;
    transition:width 0.4s;
  }
  .bar.bad{ background:#dc2626; }
  .bar.mid{ background:#6b7280; }

  .pagination { text-align:center; margin-top:20px; }
  .pagination button { margin:0 4px; padding:6px 10px; border-radius:6px; }

  #usageCounter { text-align:right; color:#555; font-size:13px; margin-bottom:10px; }
</style>
</head>

<body>
<div class="wrap">

<h1>ğŸ“ˆ SmartTube Finder â€” ë²¤ì¹˜ë§ˆí‚¹</h1>
<div id="usageCounter">ì¿¼í„° ì”ì—¬: 10000 / 10000</div>

<div class="box">
  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    <input id="q" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ë³µì§€, ê±´ê°•, ë‹¤ì´ì–´íŠ¸)" style="flex:1;">
    <button id="searchBtn">ê²€ìƒ‰</button>
  </div>

  <div style="margin-top:10px; display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:10px;">
    
    <div>
      <label>êµ¬ë¶„</label>
      <select id="typeFilter">
        <option value="any">ì „ì²´</option>
        <option value="video">ì¼ë°˜ì˜ìƒ</option>
        <option value="shorts">ì‡¼ì¸ </option>
        <option value="live">ë¼ì´ë¸Œ</option>
        <option value="channel">ì±„ë„</option>
      </select>
    </div>

    <div>
      <label>ì—…ë¡œë“œ ê¸°ê°„</label>
      <select id="timeFilter">
        <option value="any">ì „ì²´</option>
        <option value="today">ì˜¤ëŠ˜</option>
        <option value="week">ìµœê·¼ 1ì£¼</option>
        <option value="month">ì´ë²ˆ ë‹¬</option>
      </select>
    </div>

    <div>
      <label>ì •ë ¬</label>
      <select id="sortBy">
        <option value="ratio">íš¨ìœ¨ìˆœ</option>
        <option value="views">ì¡°íšŒìˆ˜ìˆœ</option>
      </select>
    </div>

    <div>
      <label>ê²°ê³¼ ê°¯ìˆ˜</label>
      <select id="maxResults">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="30">30</option>
      </select>
    </div>

  </div>
</div>

<!-- ê²°ê³¼ ë°•ìŠ¤ -->
<div id="results">
  <div class="box">
    <div style="font-weight:700; margin-bottom:6px;">ğŸ¬ ì‡¼ì¸  (4ë¶„ ë¯¸ë§Œ)</div>
    <div id="shorts"></div>
  </div>

  <div class="box">
    <div style="font-weight:700; margin-bottom:6px;">ğŸ“º ì¼ë°˜ì˜ìƒ (4ë¶„ ì´ìƒ)</div>
    <div id="longs"></div>
  </div>

  <div class="box">
    <div style="font-weight:700; margin-bottom:6px;">ğŸ“ ì±„ë„ ê²°ê³¼</div>
    <div id="channels"></div>
  </div>
</div>

<div class="pagination" id="pagination"></div>
<div id="status" style="font-size:13px; margin-top:10px;"></div>

<script>
/* ê¸°ë³¸ ì„¤ì • */
const API_KEY = "AIzaSyBMA6UbKczjPJkqExjd4_evvq3nUz-Agi8";
const TOTAL_QUOTA = 10000;
let usedQuota = 0;
let currentPage = 1;
let allRows = [];
const itemsPerPage = 10;

function updateUsage(){
  const remain = TOTAL_QUOTA - usedQuota;
  document.getElementById("usageCounter").textContent =
    `ì¿¼í„° ì”ì—¬: ${remain} / ${TOTAL_QUOTA}`;
}

function isoToSec(iso){
  if(!iso) return 0;
  const h = +(iso.match(/(\d+)H/) || [0,0])[1];
  const m = +(iso.match(/(\d+)M/) || [0,0])[1];
  const s = +(iso.match(/(\d+)S/) || [0,0])[1];
  return h*3600 + m*60 + s;
}

function cardHTML(r){
  const url = r.kind==="channel"
    ? `https://www.youtube.com/channel/${r.id}`
    : `https://www.youtube.com/watch?v=${r.id}`;

  const eff = r.eff ? r.eff.toFixed(2)+"x" : "N/A";
  const barPercent = r.eff ? Math.min(r.eff*10, 100) : 0;

  let barClass = "mid";
  if(r.eff >= 5) barClass = "";
  else if(r.eff < 1) barClass = "bad";

  return `
  <a href="${url}" target="_blank" style="text-decoration:none;color:inherit;">
    <div class="card">
      <img class="thumb" src="${r.thumb}" />

      <div>
        <span class="badge">${r.isShort?"ì‡¼ì¸ ":"ì¼ë°˜ì˜ìƒ"}</span>
        <div class="title">${r.title}</div>

        <div style="font-size:13px;color:#444;">
          ì¡°íšŒìˆ˜: <b>${r.views.toLocaleString()}</b> Â· 
          êµ¬ë…ì: <b>${r.subs ? r.subs.toLocaleString():"-"}</b>
        </div>

        <div style="font-size:13px;">
          íš¨ìœ¨: <b>${eff}</b>
          <div class="bar-wrap">
            <div class="bar ${barClass}" style="width:${barPercent}%"></div>
          </div>
        </div>

      </div>
    </div>
  </a>`;
}

function render(page){
  const shorts = document.getElementById("shorts");
  const longs = document.getElementById("longs");
  const channels = document.getElementById("channels");

  shorts.innerHTML = longs.innerHTML = channels.innerHTML = "";

  const start = (page-1)*itemsPerPage;
  const slice = allRows.slice(start, start+itemsPerPage);

  slice.forEach(r=>{
    if(r.kind==="channel") channels.innerHTML += cardHTML(r);
    else if(r.isShort) shorts.innerHTML += cardHTML(r);
    else longs.innerHTML += cardHTML(r);
  });

  renderPagination();
}

function renderPagination(){
  const total = Math.ceil(allRows.length / itemsPerPage);
  const el = document.getElementById("pagination");
  el.innerHTML = "";
  if(total <= 1) return;

  for(let i=1;i<=total;i++){
    const b=document.createElement("button");
    b.textContent=i;
    if(i===currentPage) b.style.background="#e60023";
    b.onclick=()=>{currentPage=i; render(i);};
    el.appendChild(b);
  }
}

document.getElementById("searchBtn").addEventListener("click", search);

async function search(){
  const q = document.getElementById("q").value.trim();
  if(!q) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  document.getElementById("status").textContent="ê²€ìƒ‰ ì¤‘...";

  usedQuota += 100; updateUsage();

  const maxR = document.getElementById("maxResults").value;
  const sURL = 
    `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(q)}&maxResults=${maxR}&key=${API_KEY}`;

  const sRes = await fetch(sURL); const sData = await sRes.json();

  const videoIds = [];
  const chSet = new Set();

  (sData.items||[]).forEach(it=>{
    if(it.id.videoId){
      videoIds.push(it.id.videoId);
      chSet.add(it.snippet.channelId);
    }
  });

  usedQuota += videoIds.length; updateUsage();

  const vURL =
    `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,statistics&id=${videoIds.join(',')}&key=${API_KEY}`;

  const vRes = await fetch(vURL); const vData = await vRes.json();

  const chList = [...chSet];
  let chMap = {};

  if(chList.length){
    usedQuota += chList.length; updateUsage();

    const cURL=
      `https://www.googleapis.com/youtube/v3/channels?part=statistics,snippet&id=${chList.join(',')}&key=${API_KEY}`;

    const cRes = await fetch(cURL); const cData = await cRes.json();
    (cData.items||[]).forEach(c=>chMap[c.id]=c);
  }

  const rows = [];

  (vData.items||[]).forEach(v=>{
    const d=isoToSec(v.contentDetails.duration);
    const isShort = d<240;    // <4ë¶„
    const isLong = d>=240;    // >=4ë¶„

    const subs = chMap[v.snippet.channelId]
      ? +chMap[v.snippet.channelId].statistics.subscriberCount : 0;

    const views = +v.statistics.viewCount;
    const eff = subs ? (views/subs) : 0;

    rows.push({
      kind:"video",
      id:v.id,
      title:v.snippet.title,
      thumb:v.snippet.thumbnails.medium.url,
      views, subs, eff,
      isShort, isLong
    });
  });

  allRows = rows;
  currentPage = 1;

  render(1);
  document.getElementById("status").textContent =
    `${rows.length}ê°œì˜ ê²°ê³¼`;
}

updateUsage();
</script>

</body>
</html>
