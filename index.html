<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartTube Finder â€” ë²¤ì¹˜ë§ˆí‚¹</title>
<style>
  :root{--accent:#e60023;--muted:#6b7280}
  body{font-family:Noto Sans KR, Arial, sans-serif;background:#f7fafc;margin:0;padding:18px;color:#111}
  .wrap{max-width:980px;margin:0 auto}
  h1{color:var(--accent);text-align:center;margin:6px 0 18px}
  .box{background:#fff;padding:12px;border-radius:12px;box-shadow:0 4px 18px rgba(10,10,10,0.06);margin-bottom:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button{padding:8px 10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
  button{background:var(--accent);color:#fff;border:none;cursor:pointer}
  .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  #results{display:grid;gap:12px;margin-top:12px}
  .card{background:#fff;border-radius:10px;padding:10px;display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:start;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
  .thumb{width:100%;height:92px;object-fit:cover;border-radius:8px}
  .title{font-weight:700;margin:0 0 6px}
  .meta{font-size:13px;color:#374151}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;background:#f3f4f6;margin-right:6px}
  .ratio-good{color:#16a34a;font-weight:700}
  .ratio-bad{color:#dc2626;font-weight:700}
  .small{font-size:12px;color:#6b7280}
  .note{font-size:13px;color:#6b7280;margin-top:6px}
  @media(max-width:640px){.card{grid-template-columns:120px 1fr}.thumb{height:80px}}
  .section-title{margin:12px 0 6px;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“ˆ SmartTube Finder â€” ë²¤ì¹˜ë§ˆí‚¹</h1>

  <div class="box">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input id="q" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ë³µì§€ ì‚¬ì—°, ê±´ê°•, ë‹¤ì´ì–´íŠ¸)" style="flex:1" />
      <button id="searchBtn">ê²€ìƒ‰</button>
    </div>

    <div style="margin-top:10px" class="filters">
      <div><label>êµ¬ë¶„ (íƒ€ì…)</label>
        <select id="typeFilter"><option value="any">ì „ì²´</option><option value="video">ì¼ë°˜ì˜ìƒ</option><option value="shorts">ì‡¼ì¸ </option><option value="live">ë¼ì´ë¸Œ</option><option value="channel">ì±„ë„</option></select>
      </div>

      <div><label>ì—…ë¡œë“œ ê¸°ê°„</label>
        <select id="timeFilter"><option value="any">ì „ì²´</option><option value="today">ì˜¤ëŠ˜</option><option value="week">ìµœê·¼ 1ì£¼</option><option value="month">ì´ë²ˆ ë‹¬</option><option value="3months">3ê°œì›”</option><option value="6months">6ê°œì›”</option><option value="year">ì˜¬í•´</option></select>
      </div>

      <div><label>ì¡°íšŒìˆ˜ (ìµœì†Œ ~ ìµœëŒ€)</label>
        <div style="display:flex;gap:6px"><input id="minViews" type="number" placeholder="ìµœì†Œ"/><input id="maxViews" type="number" placeholder="ìµœëŒ€"/></div>
      </div>

      <div><label>êµ¬ë…ì (ìµœì†Œ ~ ìµœëŒ€)</label>
        <div style="display:flex;gap:6px"><input id="minSubs" type="number" placeholder="ìµœì†Œ"/><input id="maxSubs" type="number" placeholder="ìµœëŒ€"/></div>
      </div>

      <div><label>ì •ë ¬</label>
        <select id="sortBy"><option value="ratio">íš¨ìœ¨ìˆœ</option><option value="views">ì¡°íšŒìˆ˜ ìˆœ</option><option value="subs">êµ¬ë…ì ìˆœ</option></select>
      </div>

      <div><label>ê²°ê³¼ ê°¯ìˆ˜</label>
        <select id="maxResults"><option value="10">10</option><option value="20" selected>20</option><option value="30">30</option></select>
      </div>
    </div>
    <div class="note">ì„¤ëª…: ì‡¼ì¸  = < 4ë¶„, ì¼ë°˜ë™ì˜ìƒ = â‰¥ 5ë¶„, 4:00~4:59 êµ¬ê°„ì€ 'ì¤‘ê°„'ìœ¼ë¡œ ë”°ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>

  <!-- ì„¹ì…˜ë³„ ê²°ê³¼ í‘œì‹œ -->
  <div id="results">
    <div class="box"><div class="section-title">ğŸ¬ ì‡¼ì¸  (4ë¶„ ë¯¸ë§Œ)</div><div id="shorts" style="display:grid;gap:8px"></div></div>
    <div class="box"><div class="section-title">â¸ 4-5ë¶„ (ì¤‘ê°„)</div><div id="mid" style="display:grid;gap:8px"></div></div>
    <div class="box"><div class="section-title">ğŸ“º ì¼ë°˜ë™ì˜ìƒ (5ë¶„ ì´ìƒ)</div><div id="longs" style="display:grid;gap:8px"></div></div>
    <div class="box"><div class="section-title">ğŸ“ ì±„ë„ ê²°ê³¼</div><div id="channels" style="display:grid;gap:8px"></div></div>
  </div>

  <div id="status" class="small" style="margin-top:10px"></div>
</div>

<script>
/* --------- ë°˜ë“œì‹œ ì—¬ê¸°ì— ë³¸ì¸ API í‚¤ ë„£ê¸° --------- */
const API_KEY = "AIzaSyBMA6UbKczjPJkqExjd4_evvq3nUz-Agi8";
/* ------------------------------------------------- */

// ìœ í‹¸: ì—…ë¡œë“œ ê¸°ê°„ -> publishedAfter ISO
function getPublishedAfter(period){
  if(!period || period === "any") return "";
  const now = new Date();
  if(period === "today") now.setDate(now.getDate()-1);
  if(period === "week") now.setDate(now.getDate()-7);
  if(period === "month") now.setMonth(now.getMonth()-1);
  if(period === "3months") now.setMonth(now.getMonth()-3);
  if(period === "6months") now.setMonth(now.getMonth()-6);
  if(period === "year") now.setFullYear(now.getFullYear()-1);
  return now.toISOString();
}

// ISO duration -> seconds (ê°„ë‹¨ íŒŒì„œ)
function isoToSeconds(iso){
  if(!iso) return 0;
  const h = (iso.match(/(\d+)H/) || [0,0])[1]||0;
  const m = (iso.match(/(\d+)M/) || [0,0])[1]||0;
  const s = (iso.match(/(\d+)S/) || [0,0])[1]||0;
  return Number(h)*3600 + Number(m)*60 + Number(s);
}

document.getElementById('q').addEventListener('keydown', e=>{ if(e.key === 'Enter') document.getElementById('searchBtn').click(); });
document.getElementById('searchBtn').addEventListener('click', onSearch);

async function onSearch(){
  const q = document.getElementById('q').value.trim();
  if(!q){ alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
  const type = document.getElementById('typeFilter').value;
  const time = document.getElementById('timeFilter').value;
  const minV = Number(document.getElementById('minViews').value) || 0;
  const maxV = Number(document.getElementById('maxViews').value) || Infinity;
  const minS = Number(document.getElementById('minSubs').value) || 0;
  const maxS = Number(document.getElementById('maxSubs').value) || Infinity;
  const sortBy = document.getElementById('sortBy').value;
  const maxResults = Number(document.getElementById('maxResults').value) || 20;

  // ì´ˆê¸°í™”
  document.getElementById('shorts').innerHTML = "";
  document.getElementById('mid').innerHTML = "";
  document.getElementById('longs').innerHTML = "";
  document.getElementById('channels').innerHTML = "";
  document.getElementById('status').textContent = "ê²€ìƒ‰ ì¤‘... (API ìš”ì²­ì´ ìˆœì°¨ì ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤)";

  try{
    // 1) search ì—”ë“œí¬ì¸íŠ¸ë¡œ í›„ë³´ ê°€ì ¸ì˜¤ê¸°
    let searchType = "video";
    let eventType = "";
    if(type === "channel") searchType = "channel";
    if(type === "live"){ searchType = "video"; eventType="&eventType=live"; }
    // search: q, type, maxResults, publishedAfter
    const publishedAfter = getPublishedAfter(time);
    let sUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=${searchType}&q=${encodeURIComponent(q)}&maxResults=${maxResults}&key=${API_KEY}${eventType}`;
    if(publishedAfter) sUrl += `&publishedAfter=${encodeURIComponent(publishedAfter)}`;
    const sRes = await fetch(sUrl);
    const sData = await sRes.json();
    if(sData.error) throw new Error(sData.error.message || "Search API error");

    // ëª¨ìŒ
    const videoIds = [];
    const channelIds = new Set();

    for(const it of sData.items || []){
      if(it.id.kind === "youtube#video"){
        videoIds.push(it.id.videoId);
        if(it.snippet && it.snippet.channelId) channelIds.add(it.snippet.channelId);
      } else if(it.id.kind === "youtube#channel"){
        channelIds.add(it.id.channelId);
      }
    }

    // 2) videos ìƒì„¸(í†µê³„+contentDetails) ê°€ì ¸ì˜¤ê¸°
    const videosMap = {};
    if(videoIds.length){
      const vUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails,snippet&id=${videoIds.join(',')}&key=${API_KEY}`;
      const vRes = await fetch(vUrl);
      const vData = await vRes.json();
      if(vData.error) throw new Error(vData.error.message || "Videos API error");
      for(const v of vData.items || []) videosMap[v.id] = v;
    }

    // 3) channels ìƒì„¸ ê°€ì ¸ì˜¤ê¸°
    const channelsMap = {};
    if(channelIds.size){
      const cList = Array.from(channelIds).join(',');
      const cUrl = `https://www.googleapis.com/youtube/v3/channels?part=statistics,snippet&id=${cList}&key=${API_KEY}`;
      const cRes = await fetch(cUrl);
      const cData = await cRes.json();
      if(cData.error) throw new Error(cData.error.message || "Channels API error");
      for(const c of cData.items || []) channelsMap[c.id] = c;
    }

    // 4) ê°€ê³µ ë° í•„í„°ë§
    const rows = [];
    for(const it of sData.items || []){
      if(it.id.kind === "youtube#channel"){
        const cid = it.id.channelId;
        const ch = channelsMap[cid];
        if(!ch) continue;
        const subs = Number(ch.statistics.subscriberCount || 0);
        const totalViews = Number(ch.statistics.viewCount || 0);
        if(subs < minS || subs > maxS || totalViews < minV || totalViews > maxV) continue;
        rows.push({kind:'channel', id:cid, title:ch.snippet.title, thumbnail:ch.snippet.thumbnails?.medium?.url || '', subs, views: totalViews, efficiency: subs?totalViews/subs:null, publishedAt: null});
      } else if(it.id.kind === "youtube#video"){
        const vid = it.id.videoId;
        const v = videosMap[vid];
        if(!v) continue;
        const channelId = v.snippet.channelId;
        const ch = channelsMap[channelId] || null;
        const videoViews = Number(v.statistics.viewCount || 0);
        const durationSec = isoToSeconds(v.contentDetails?.duration);
        const isShort = durationSec > 0 && durationSec < 4*60; // < 4ë¶„
        const isLong = durationSec >= 5*60; // >= 5ë¶„
        const isMid = !isShort && !isLong; // 4:00 ~ 4:59
        const subs = ch ? Number(ch.statistics.subscriberCount || 0) : 0;
        if(videoViews < minV || videoViews > maxV) continue;
        if(subs < minS || subs > maxS) continue;
        rows.push({kind:'video', id:vid, title:v.snippet.title, thumbnail:v.snippet.thumbnails?.medium?.url || '', subs, views:videoViews, efficiency: subs?videoViews/subs:null, durationSec, isShort, isMid, isLong, channelId, channelTitle:v.snippet.channelTitle, publishedAt: v.snippet.publishedAt});
      }
    }

    // 5) ì •ë ¬
    rows.sort((a,b)=>{
      if(sortBy === 'views') return (b.views||0)-(a.views||0);
      if(sortBy === 'subs') return (b.subs||0)-(a.subs||0);
      // efficiency
      const ra = a.efficiency||0; const rb = b.efficiency||0;
      return rb-ra;
    });

    // 6) ë Œë”ë§: ì„¹ì…˜ë³„ë¡œ ë‚˜ëˆ„ì–´ í‘œì‹œ
    const shortsEl = document.getElementById('shorts');
    const midEl = document.getElementById('mid');
    const longsEl = document.getElementById('longs');
    const channelsEl = document.getElementById('channels');
    let count = 0;

    for(const r of rows){
      if(r.kind === 'channel'){
        const html = renderCard(r,'channel');
        channelsEl.insertAdjacentHTML('beforeend', html);
        count++;
      } else if(r.kind === 'video'){
        const html = renderCard(r,'video');
        if(r.isShort) shortsEl.insertAdjacentHTML('beforeend', html);
        else if(r.isMid) midEl.insertAdjacentHTML('beforeend', html);
        else if(r.isLong) longsEl.insertAdjacentHTML('beforeend', html);
        count++;
      }
    }

    document.getElementById('status').textContent = `ì™„ë£Œ â€” ê²°ê³¼ ${count}ê°œ (API ì‚¬ìš©ëŸ‰ì— ìœ ì˜í•˜ì„¸ìš”)`;

  }catch(err){
    console.error(err);
    document.getElementById('status').textContent = `ì˜¤ë¥˜: ${err.message || err}`;
    document.getElementById('shorts').innerHTML = '';
    document.getElementById('mid').innerHTML = '';
    document.getElementById('longs').innerHTML = '';
    document.getElementById('channels').innerHTML = '';
  }
}

function renderCard(r, type){
  const eff = r.efficiency===null ? 'N/A' : Number(r.efficiency).toFixed(2) + 'x';
  const badge = r.kind==='channel' ? '<span class="badge">ì±„ë„</span>' : (r.isShort ? '<span class="badge">ì‡¼ì¸ </span>' : r.isMid ? '<span class="badge">4-5ë¶„</span>' : '<span class="badge">ë™ì˜ìƒ</span>');
  const published = r.publishedAt ? new Date(r.publishedAt).toLocaleDateString() : '-';
  const thumbnail = r.thumbnail || '';
  const link = r.kind==='channel' ? `https://www.youtube.com/channel/${r.id}` : `https://www.youtube.com/watch?v=${r.id}`;
  return `<div class="card">
    <div><img class="thumb" src="${thumbnail}" alt="thumb"></div>
    <div>
      <div class="small">${badge}</div>
      <div class="title">${r.title}</div>
      <div class="meta small">${r.kind==='video' ? `ì±„ë„: ${r.channelTitle || ''}` : ''}</div>
      <div class="meta">ì¡°íšŒìˆ˜: <strong>${(r.views||0).toLocaleString()}</strong> Â· êµ¬ë…ì: <strong>${(r.subs||0).toLocaleString()}</strong></div>
      <div class="meta">íš¨ìœ¨: <strong class="${r.efficiency && r.efficiency>=5 ? 'ratio-good' : r.efficiency && r.efficiency<1 ? 'ratio-bad' : ''}">${eff}</strong></div>
      <div class="meta">ì—…ë¡œë“œ: ${published}</div>
      <div style="margin-top:8px"><a href="${link}" target="_blank"><button>ìœ íŠœë¸Œì—ì„œ ë³´ê¸°</button></a></div>
    </div>
  </div>`;
}
</script>
</body>
</html>
